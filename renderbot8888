import subprocess
import json
import time
import numpy as np
import pandas as pd
from sklearn.ensemble import RandomForestRegressor

# Configurations
COIN = "ATOM"
PAIR = "ATOMUSDT_PERP"
MIN_QUANTITY = 0.001
FEE = 0.0005  # hypothetical fee
PREDICTION_HORIZON = 60  # seconds

# Initialize ML model
model = RandomForestRegressor()

# Helper functions
def get_coin_info():
    result = subprocess.run(['/coinrealinfo.sh', PAIR], capture_output=True, text=True)
    output = result.stdout.strip()
    if output == "NO INFO":
        return None
    info = {}
    for line in output.splitlines():
        key, value = line.split(':', 1)
        info[key.strip()] = value.strip()
    return info

def get_wallet_balance():
    result = subprocess.run(['/wallet.sh', 'get'], capture_output=True, text=True)
    balance_str = result.stdout.strip().split()[0]
    return float(balance_str)

def place_order(side, quantity):
    result = subprocess.run(['/placeorder.sh', COIN, str(quantity), side], capture_output=True, text=True)
    return result.stdout.strip()

def close_all_positions():
    result = subprocess.run(['/closepositions.sh'], capture_output=True, text=True)
    return json.loads(result.stdout)

def write_dashboard(metrics):
    html_content = f"""
    <html>
    <head><title>Trading Dashboard</title></head>
    <body>
    <h1>ATOM Trading Dashboard</h1>
    <p>Balance: {metrics['balance']} USDT</p>
    <p>Open Positions: {metrics['positions']}</p>
    <p>Predicted Next Price: {metrics['predicted_price']}</p>
    <p>Current Signal: {metrics['signal']}</p>
    <p>Total PnL: {metrics['pnl']}</p>
    </body></html>
    """
    with open('/var/www/html/dashboard.html', 'w') as f:
        f.write(html_content)

# Main loop
def main():
    # Initial cleanup
    close_all_positions()
    balance = get_wallet_balance()

    # Collect historical data for ML
    history = pd.DataFrame(columns=['price'])

    while True:
        info = get_coin_info()
        if info:
            current_price = float(info.get('Bid', '0'))
            # Append to history
            history = history.append({'price': current_price}, ignore_index=True)
            if len(history) > 10:
                # Prepare features and target for ML
                X = history['price'].values[:-1].reshape(-1, 1)
                y = history['price'].values[1:]
                try:
                    model.fit(X, y)
                except Exception as e:
                    pass

                # Predict next price
                pred_price = model.predict(np.array([[current_price]]))[0]
            else:
                pred_price = current_price

            # Generate signal based on prediction
            signal = 'buy' if pred_price > current_price else 'sell'

            # Decide to open or close positions
            positions_info = subprocess.run(['/coinrealinfo.sh', PAIR], capture_output=True, text=True).stdout
            open_positions = json.loads(positions_info) if 'open_positions' in positions_info else []

            # Placeholder for detailed strategy
            if not open_positions and balance > MIN_QUANTITY:
                qty = max(MIN_QUANTITY, balance * 0.1)  # scale size
                result = place_order(signal, qty)
                print(f"Placed {signal} order for {qty}: {result}")

            # Close positions if profit exceeds fee
            pnl_info = get_coin_info()
            if pnl_info:
                pnl = float(pnl_info.get('Unrealized PnL', '0'))
                if pnl > FEE:
                    subprocess.run(['/closepositions.sh'])

            # Update dashboard
            metrics = {
                'balance': balance,
                'positions': len(open_positions),
                'predicted_price': pred_price,
                'signal': signal,
                'pnl': pnl if 'pnl' in locals() else 0
            }
            write_dashboard(metrics)

        time.sleep(5)

if __name__ == "__main__":
    main()
